name: publish-apt-repo

permissions:
  contents: read

on:
  release:
    types: [published]

jobs:
  publish-apt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4

      # Local test notes:
      # - Build .deb with packaging/build_deb.sh
      # - Regenerate APT metadata in gdlex-apt-repo clone
      # - Validate install via apt using a temporary file:// source list

      - name: Resolve version from release tag
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          RAW_TAG="${{ github.event.release.tag_name }}"
          VERSION="${RAW_TAG#v}"
          if [[ -z "$VERSION" ]]; then
            echo "Errore: versione non risolta da release tag" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved VERSION=$VERSION"

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y rsync dpkg-dev apt-utils
          python -m pip install --upgrade pip
          pip install -e .

      - name: Build Debian package
        shell: bash
        env:
          APP_VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          ./packaging/build_deb.sh

      - name: Verify built .deb exists and is valid
        id: deb
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          DEB="dist/gdlex-pct-validator_${VERSION}_amd64.deb"
          if [[ ! -f "$DEB" ]]; then
            echo "Errore: pacchetto non trovato: $DEB" >&2
            echo "Contenuto dist/:" >&2
            ls -la dist >&2 || true
            exit 1
          fi
          dpkg-deb -I "$DEB" >/tmp/deb-info.txt
          dpkg-deb -c "$DEB" >/tmp/deb-contents.txt
          echo "deb_path=$DEB" >> "$GITHUB_OUTPUT"
          echo "Found and validated DEB: $DEB"

      - name: Checkout APT repository
        uses: actions/checkout@v4
        with:
          repository: cortomaltese88/gdlex-apt-repo
          token: ${{ secrets.GDEX_APT_REPO_PAT }}
          path: gdlex-apt-repo

      - name: Copy package and regenerate APT indexes
        shell: bash
        env:
          DEB_PATH: ${{ steps.deb.outputs.deb_path }}
        run: |
          set -euo pipefail
          APT_REPO_DIR="gdlex-apt-repo"
          POOL_DIR="$APT_REPO_DIR/pool/main/g/gdlex-pct-validator"
          DIST_ROOT="$APT_REPO_DIR/dists/stable"
          DIST_DIR="$DIST_ROOT/main/binary-amd64"

          mkdir -p "$POOL_DIR" "$DIST_DIR"
          cp -f "$DEB_PATH" "$POOL_DIR/"

          if [[ ! -f "$POOL_DIR/$(basename "$DEB_PATH")" ]]; then
            echo "Errore: copia .deb fallita nel repo APT" >&2
            exit 1
          fi

          pushd "$APT_REPO_DIR" >/dev/null
          dpkg-scanpackages -m pool /dev/null > dists/stable/main/binary-amd64/Packages
          gzip -9c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz
          apt-ftparchive release dists/stable > dists/stable/Release

          test -s dists/stable/main/binary-amd64/Packages
          test -s dists/stable/main/binary-amd64/Packages.gz
          test -s dists/stable/Release
          popd >/dev/null

      - name: Verify generated indexes contain expected version
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          PKG_FILE="gdlex-apt-repo/dists/stable/main/binary-amd64/Packages"
          grep -n "^Package: gdlex-pct-validator$" "$PKG_FILE" >/dev/null
          grep -n "^Version: ${VERSION}$" "$PKG_FILE" >/dev/null
          echo "Packages index contains gdlex-pct-validator ${VERSION}"

      - name: Offline installability check using local file:// APT source
        shell: bash
        run: |
          set -euo pipefail
          SRC_LIST="$(mktemp)"
          LIST_DIR="$(mktemp -d)"
          CACHE_DIR="$(mktemp -d)"

          printf "%s\n" "deb [arch=amd64 trusted=yes] file://$(pwd)/gdlex-apt-repo stable main" > "$SRC_LIST"

          sudo apt-get \
            -o Dir::Etc::sourcelist="$SRC_LIST" \
            -o Dir::Etc::sourceparts="-" \
            -o APT::Get::List-Cleanup="0" \
            -o Dir::State::lists="$LIST_DIR" \
            -o Dir::Cache::archives="$CACHE_DIR" \
            update

          sudo apt-get \
            -o Dir::Etc::sourcelist="$SRC_LIST" \
            -o Dir::Etc::sourceparts="-" \
            -o APT::Get::List-Cleanup="0" \
            -o Dir::State::lists="$LIST_DIR" \
            -o Dir::Cache::archives="$CACHE_DIR" \
            install -y gdlex-pct-validator

      - name: Commit and push APT repository
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          pushd gdlex-apt-repo >/dev/null
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add pool dists
          if git diff --cached --quiet; then
            echo "Nessuna modifica da pubblicare nel repo APT."
            popd >/dev/null
            exit 0
          fi

          git commit -m "Add gdlex-pct-validator $VERSION"
          git push origin main
          popd >/dev/null

      - name: Final check (non-blocking remote visibility)
        shell: bash
        run: |
          set -euo pipefail
          test -s gdlex-apt-repo/dists/stable/main/binary-amd64/Packages
          test -s gdlex-apt-repo/dists/stable/main/binary-amd64/Packages.gz
          curl -fsSI https://cortomaltese88.github.io/gdlex-apt-repo/dists/stable/main/binary-amd64/Packages.gz \
            && echo "Remote URL reachable (may still be cached)." \
            || echo "Remote URL not yet reachable (possible Pages cache delay)."

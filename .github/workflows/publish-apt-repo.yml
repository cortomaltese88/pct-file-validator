name: publish-apt-repo

permissions:
  contents: read

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Versione da pubblicare (es. 1.2.3 o v1.2.3). Obbligatoria per run manuale."
        required: false
        type: string

concurrency:
  group: publish-apt-repo-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-apt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4

      - name: Resolve version from event/tag/dispatch input
        id: ver
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          REF_NAME: ${{ github.ref_name }}
          REF_TYPE: ${{ github.ref_type }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail

          RAW_TAG=""
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            if [[ -z "${INPUT_VERSION:-}" ]]; then
              echo "Errore: workflow_dispatch richiede input 'version'." >&2
              exit 1
            fi
            RAW_TAG="$INPUT_VERSION"
          elif [[ "$EVENT_NAME" == "release" && -n "${RELEASE_TAG:-}" ]]; then
            RAW_TAG="$RELEASE_TAG"
          elif [[ "$REF_TYPE" == "tag" && -n "${REF_NAME:-}" ]]; then
            RAW_TAG="$REF_NAME"
          elif [[ -n "${INPUT_VERSION:-}" ]]; then
            RAW_TAG="$INPUT_VERSION"
          fi

          VERSION="${RAW_TAG#v}"
          if [[ -z "$VERSION" ]]; then
            echo "Errore: impossibile risolvere la versione da release/tag/input." >&2
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved VERSION=$VERSION"

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils rsync curl gzip
          python -m pip install --upgrade pip
          pip install pillow
          pip install -e .

      - name: Build Debian package
        shell: bash
        env:
          APP_VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          ./packaging/build_deb.sh

      - name: Locate and validate .deb artifact
        id: deb
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail

          EXPECTED="dist/gdlex-pct-validator_${VERSION}_amd64.deb"
          DEB_PATH=""

          if [[ -f "$EXPECTED" ]]; then
            DEB_PATH="$EXPECTED"
          else
            MATCHES=(dist/gdlex-pct-validator_"${VERSION}"_*.deb)
            if [[ ${#MATCHES[@]} -eq 1 && -f "${MATCHES[0]}" ]]; then
              DEB_PATH="${MATCHES[0]}"
            fi
          fi

          if [[ -z "$DEB_PATH" ]]; then
            echo "Errore: pacchetto .deb non trovato per versione $VERSION in dist/." >&2
            ls -la dist >&2 || true
            exit 1
          fi

          dpkg-deb -I "$DEB_PATH" >/tmp/deb-info.txt
          dpkg-deb -c "$DEB_PATH" >/tmp/deb-contents.txt
          echo "deb_path=$DEB_PATH" >> "$GITHUB_OUTPUT"
          echo "Using DEB: $DEB_PATH"

      - name: Preflight guard for APT repo token
        shell: bash
        env:
          APT_TOKEN: ${{ secrets.GDLEX_APT_REPO_TOKEN }}
        run: |
          set -euo pipefail
          test -n "$APT_TOKEN" || (echo "Missing secret GDLEX_APT_REPO_TOKEN" >&2; exit 1)

      - name: Checkout APT repository
        uses: actions/checkout@v4
        with:
          repository: cortomaltese88/gdlex-apt-repo
          token: ${{ secrets.GDLEX_APT_REPO_TOKEN }}
          path: gdlex-apt-repo

      - name: Publish package and regenerate APT indexes
        shell: bash
        env:
          DEB_PATH: ${{ steps.deb.outputs.deb_path }}
        run: |
          set -euo pipefail

          APT_REPO_DIR="gdlex-apt-repo"
          POOL_DIR="$APT_REPO_DIR/pool/main/g/gdlex-pct-validator"
          DIST_DIR="$APT_REPO_DIR/dists/stable/main/binary-amd64"

          mkdir -p "$POOL_DIR" "$DIST_DIR"
          cp -f "$DEB_PATH" "$POOL_DIR/"

          pushd "$APT_REPO_DIR" >/dev/null
          dpkg-scanpackages -m pool /dev/null > dists/stable/main/binary-amd64/Packages
          gzip -9c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz
          popd >/dev/null

      - name: Hard checks on generated indexes
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail

          PKG_FILE="gdlex-apt-repo/dists/stable/main/binary-amd64/Packages"
          PKG_GZ="gdlex-apt-repo/dists/stable/main/binary-amd64/Packages.gz"

          test -s "$PKG_FILE"
          grep -q '^Package: gdlex-pct-validator$' "$PKG_FILE"
          grep -q "^Version: ${VERSION}$" "$PKG_FILE"
          test -s "$PKG_GZ"

          echo "Hard checks passed for version ${VERSION}."

      - name: Commit and push APT repository
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail

          pushd gdlex-apt-repo >/dev/null
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add pool dists
          if git diff --cached --quiet; then
            echo "Nessuna modifica da pubblicare nel repo APT."
            popd >/dev/null
            exit 0
          fi

          git commit -m "Add gdlex-pct-validator ${VERSION}"
          git push origin main
          popd >/dev/null

      - name: Remote visibility check (non-blocking with retry)
        shell: bash
        run: |
          set -euo pipefail

          URL="https://cortomaltese88.github.io/gdlex-apt-repo/dists/stable/main/binary-amd64/Packages.gz"
          ATTEMPTS=10
          SLEEP_SECONDS=15
          ok=0

          for i in $(seq 1 "$ATTEMPTS"); do
            if curl -fsSI "$URL" >/dev/null; then
              echo "Remote Packages.gz raggiungibile al tentativo $i/$ATTEMPTS"
              ok=1
              break
            fi
            echo "Tentativo $i/$ATTEMPTS fallito; nuovo tentativo tra ${SLEEP_SECONDS}s..."
            sleep "$SLEEP_SECONDS"
          done

          if [[ "$ok" -ne 1 ]]; then
            echo "::warning::Packages.gz non ancora raggiungibile dopo ${ATTEMPTS} tentativi (possibile delay GitHub Pages)."
          fi

  apt-repo-sanity:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: apt repo sanity
        shell: bash
        run: |
          set -euo pipefail
          echo "apt repo sanity"

      - name: Preflight guard for APT repo token
        shell: bash
        env:
          APT_TOKEN: ${{ secrets.GDLEX_APT_REPO_TOKEN }}
        run: |
          set -euo pipefail
          test -n "$APT_TOKEN" || (echo "Missing secret GDLEX_APT_REPO_TOKEN" >&2; exit 1)

      - name: Checkout APT repository
        uses: actions/checkout@v4
        with:
          repository: cortomaltese88/gdlex-apt-repo
          token: ${{ secrets.GDLEX_APT_REPO_TOKEN }}
          path: gdlex-apt-repo

      - name: Show first 30 lines of Packages
        shell: bash
        run: |
          set -euo pipefail
          PKG_FILE="gdlex-apt-repo/dists/stable/main/binary-amd64/Packages"
          if [[ ! -f "$PKG_FILE" ]]; then
            echo "Packages non trovato: $PKG_FILE" >&2
            exit 1
          fi
          sed -n '1,30p' "$PKG_FILE"
